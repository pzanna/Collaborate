#!/usr/bin/env python3
"""
Simple Research Test - User creates topic, Research Manager handles everything

This test demonstrates the intended workflow:
1. User creates a project (optional)
2. User creates a topic with research query
3. Research Manager automatically handles:
   - Creating research plans
   - Breaking down into tasks
   - Executing with AI agents
   - Generating comprehensive results
"""

import json
import time
import requests
from urllib.parse import quote
from typing import Optional, Dict, Any, Tuple

# Constants
API_URL = "http://localhost:8000/api/v2"
SUCCESS_STATUS = 200


def make_request(method: str, endpoint: str, json_data: Optional[Dict[str, Any]] = None) -> Tuple[bool, Optional[Dict[str, Any]], str]:
    """Make HTTP request to the API."""
    url = f"{API_URL}/{endpoint.lstrip('/')}"
    
    try:
        response = requests.request(method, url, json=json_data)
        
        if response.status_code == SUCCESS_STATUS:
            return True, response.json(), ""
        else:
            error_msg = f"Request failed with status {response.status_code}: {response.text}"
            return False, None, error_msg
            
    except requests.RequestException as e:
        error_msg = f"Request error: {str(e)}"
        return False, None, error_msg


def create_project(name: str, description: str) -> Tuple[bool, Optional[str]]:
    """Create a research project."""
    project_data = {"name": name, "description": description}
    success, response_data, error_msg = make_request("POST", "/projects", project_data)
    
    if success and response_data:
        project_id = response_data.get("id")
        print(f"âœ… Project '{name}' created successfully.")
        print(f"   Project ID: {project_id}")
        return True, project_id
    else:
        print(f"âŒ Failed to create project: {error_msg}")
        return False, None


def create_topic(project_id: str, name: str, description: str) -> Tuple[bool, Optional[str]]:
    """Create a research topic."""
    topic_data = {"name": name, "description": description}
    success, response_data, error_msg = make_request(
        "POST", f"/projects/{project_id}/topics", topic_data
    )
    
    if success and response_data:
        topic_id = response_data.get("id")
        print(f"âœ… Research topic '{name}' created successfully.")
        print(f"   Topic ID: {topic_id}")
        return True, topic_id
    else:
        print(f"âŒ Failed to create research topic: {error_msg}")
        return False, None


def start_research(topic_id: str, query: str) -> Tuple[bool, Optional[Dict[str, Any]]]:
    """Start research on a topic - Research Manager handles everything."""
    success, response_data, error_msg = make_request(
        "POST", f"/topics/{topic_id}/research?query={quote(query)}"
    )
    
    if success and response_data:
        print("ğŸš€ Research started successfully!")
        print(f"   Research Task ID: {response_data.get('research_task_id')}")
        print(f"   Query: {response_data.get('query')}")
        return True, response_data
    else:
        print(f"âŒ Failed to start research: {error_msg}")
        return False, None


def get_topic_with_research_results(topic_id: str) -> Optional[Dict[str, Any]]:
    """Get topic with all generated research results."""
    success, response_data, error_msg = make_request("GET", f"/topics/{topic_id}")
    
    if success and response_data:
        return response_data
    else:
        print(f"âŒ Failed to get topic: {error_msg}")
        return None


def get_research_plan_details(topic_id: str) -> Optional[Dict[str, Any]]:
    """Get the detailed research plan generated by AI agents."""
    # First get the topic to find the plans
    topic = get_topic_with_research_results(topic_id)
    if not topic:
        return None
    
    # Get the plans for this topic
    success, response_data, error_msg = make_request("GET", f"/topics/{topic_id}/plans")
    
    if success and response_data and isinstance(response_data, list) and len(response_data) > 0:
        # Get the first (most recent) plan
        plan = response_data[0]
        plan_id = plan.get('id')
        
        # Get detailed plan information
        plan_success, plan_data, plan_error = make_request("GET", f"/plans/{plan_id}")
        
        if plan_success and plan_data:
            return plan_data
        else:
            print(f"âŒ Failed to get plan details: {plan_error}")
            return None
    else:
        print(f"âŒ Failed to get plans for topic: {error_msg}")
        return None


def approve_research_plan(plan_id: str) -> bool:
    """Approve the research plan."""
    success, response_data, error_msg = make_request("POST", f"/plans/{plan_id}/approve")

    if success and response_data:

        return True
    else:
        print(f"âŒ Failed to approve research plan: {error_msg}")
        return False
    

def run_simple_research_test():
    """Run the simple research test."""
    print("ğŸ§ª Simple Research Test - Research Manager Handles Everything")
    print("=" * 70)
    print("ğŸ“ Workflow:")
    print("   1. User creates a project")
    print("   2. User creates a topic")
    print("   3. User starts research with a query")
    print("   4. Research Manager automatically:")
    print("      â€¢ Creates comprehensive research plans")
    print("      â€¢ Breaks down into specific tasks")
    print("      â€¢ Executes with AI planning agents")
    print("      â€¢ Generates detailed research structure")
    print("=" * 70)
    
    # Test data
    project_name = "Biological AI Research Project"
    project_description = "Replacing ANN with Biological Neural Networks"
    topic_name = "Culturing Biological Neural Networks"
    topic_description = "Exploring the potential of culturing biological neural networks"
    research_query = "What are the computational models for simulating neural networks inspired by biological systems?"

    # Step 1: Create Project
    print("\nğŸ“ Step 1: Creating research project...")
    project_success, project_id = create_project(project_name, project_description)
    
    if not project_success or not project_id:
        print("âŒ Test failed: Cannot proceed without a valid project.")
        return
    
    # Step 2: Create Topic
    print("\nğŸ“ Step 2: Creating research topic...")
    topic_success, topic_id = create_topic(project_id, topic_name, topic_description)
    
    if not topic_success or not topic_id:
        print("âŒ Test failed: Cannot proceed without a valid topic.")
        return
    
    # Step 3: Start Research (Research Manager handles everything from here)
    print("\nğŸš€ Step 3: Starting research...")
    print(f"Research Query: {research_query}")
    print("ğŸ’¡ From this point, the Research Manager handles:")
    print("   â€¢ Plan creation and structure")
    print("   â€¢ Task breakdown and execution")
    print("   â€¢ AI agent coordination")
    print("   â€¢ Result synthesis")
    
    research_success, research_data = start_research(topic_id, research_query)
    
    if not research_success:
        print("âŒ Test failed: Could not start research.")
        return
    
    # Step 4: Wait and check results
    print("\nâ³ Step 4: Waiting for research completion...")
    time.sleep(15)  # Give the research manager time to work

    # Step 5: Get research plan details
    print("\nğŸ“Š Step 5: Retrieving research Plan...")
    topic_with_results = get_topic_with_research_results(topic_id)
    
    if topic_with_results:
        print("âœ… Research completed! Here's what the Research Manager created:")
        print(f"   â€¢ Topic: {topic_with_results.get('name')}")
        print(f"   â€¢ Plans Created: {topic_with_results.get('plans_count', 0)}")
        print(f"   â€¢ Tasks Created: {topic_with_results.get('tasks_count', 0)}")
        print(f"   â€¢ Status: {topic_with_results.get('status')}")
        print(f"   â€¢ Total Cost: ${topic_with_results.get('total_cost', 0):.4f}")
        
        # Get and display the detailed research plan
        print("\nï¿½ Step 6: Retrieving AI-generated research plan details...")
        plan_details = get_research_plan_details(topic_id)
        
        if plan_details:
            plan_structure = plan_details.get('plan_structure', {})
            if isinstance(plan_structure, str):
                import json
                try:
                    plan_structure = json.loads(plan_structure)
                except json.JSONDecodeError:
                    plan_structure = {}
            
            print("ğŸ“‹ AI-Generated Research Plan:")
            print("=" * 50)
            
            # Display objectives
            objectives = plan_structure.get('objectives', [])
            if objectives:
                print(f"\nğŸ¯ Research Objectives ({len(objectives)}):")
                for i, obj in enumerate(objectives, 1):
                    print(f"   {i}. {obj}")
            
            # Display key areas
            key_areas = plan_structure.get('key_areas', [])
            if key_areas:
                print(f"\nğŸ”¬ Key Research Areas ({len(key_areas)}):")
                for i, area in enumerate(key_areas, 1):
                    print(f"   {i}. {area}")
            
            # Display research questions
            questions = plan_structure.get('questions', [])
            if questions:
                print(f"\nâ“ Research Questions ({len(questions)}):")
                for i, question in enumerate(questions, 1):
                    print(f"   {i}. {question}")
            
            # Display sources
            sources = plan_structure.get('sources', [])
            if sources:
                print(f"\nğŸ“š Information Sources ({len(sources)}):")
                for i, source in enumerate(sources, 1):
                    print(f"   {i}. {source}")
            
            # Display expected outcomes
            outcomes = plan_structure.get('outcomes', [])
            if outcomes:
                print(f"\nğŸ Expected Outcomes ({len(outcomes)}):")
                for i, outcome in enumerate(outcomes, 1):
                    print(f"   {i}. {outcome}")
            
            print("=" * 50)
            # Plan id
            plan_id = plan_details.get('id')
        else:
            print("âš ï¸  Could not retrieve detailed research plan")
            
    else:
        print("âŒ Failed to retrieve research results.")
        return

    # Step 6. Approve research plan
    print("\nâœ… Approving research plan...")
    if plan_id:
        # approved = approve_research_plan(plan_id)
        approved = None
    else:
        print("âŒ No plan ID available to approve.")
        return
    if approved:
        print("âœ… Research plan approved successfully!")
    else:
        print("âŒ Failed to approve research plan.")
        return

    # Step 7: Task assignments
    print("\nğŸ“‹ Step 7: Assigning tasks from research plan")






    

    # Final summary
    # Success!
    print("\nâœ… AI Research Platform Test Completed Successfully!")
    print("=" * 60)
    print("ğŸ‰ Summary:")
    print(f"   â€¢ Project: {project_name}")
    print(f"   â€¢ Topic: {topic_name}")
    print(f"   â€¢ Query: {research_query[:50]}...")
    print("   â€¢ Research Manager: âœ… Handled all planning and execution")
    print("   â€¢ AI Planning Agent: âœ… Generated comprehensive research structure")
    print("   â€¢ Detailed Plan: âœ… Objectives, areas, questions, sources, outcomes")
    print("   â€¢ User Effort: âœ… Minimal - just created topic and query!")
    print("\nğŸ’¡ The AI agents transformed a simple query into a detailed research strategy!")
    print("=" * 60)


if __name__ == "__main__":
    try:
        run_simple_research_test()
    except KeyboardInterrupt:
        print("\nâš ï¸  Test interrupted by user.")
    except Exception as e:
        print(f"âŒ Test failed with error: {str(e)}")
