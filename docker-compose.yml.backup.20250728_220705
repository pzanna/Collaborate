# Eunice Research Platform - Version 0.3 Microservices Architecture
# Root-level orchestration following the Version 0.3 design document

services:
  # Core Services

  # 1. API Gateway Service (Port 8001)
  api-gateway:
    build: ./services/api-gateway
    container_name: eunice-api-gateway
    ports:
      - "8001:8001"
    environment:
      - HOST=0.0.0.0
      - PORT=8001
      - MCP_SERVER_HOST=mcp-server
      - MCP_SERVER_PORT=9000
      - DATABASE_URL=postgresql://postgres:password@postgres:5432/eunice # Direct connection
      - LOG_LEVEL=INFO
    networks:
      - eunice-microservices
    depends_on:
      - mcp-server
      - postgres # Direct dependency on postgres, not database-service
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 2. Enhanced MCP Server Service (Port 9000)
  mcp-server:
    build: ./services/mcp-server
    container_name: eunice-mcp-server
    ports:
      - "9000:9000"
    environment:
      - LOG_LEVEL=INFO
      - PORT=9000
      - HOST=0.0.0.0
      - REDIS_URL=redis://redis:6379
      - DATABASE_URL=postgresql://postgres:password@postgres:5432/eunice
    networks:
      - eunice-microservices
    depends_on:
      - redis
      - postgres
    restart: unless-stopped
    command: ["python", "mcp_server.py"]
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import socket; s = socket.socket(); s.connect(('localhost', 9000)); s.close()",
        ]
      interval: 30s
      timeout: 10s
      retries: 3

  # 3. AI Service (MCP Client)
  ai-service:
    build: ./services/ai-service
    container_name: eunice-ai-service
    environment:
      - MCP_SERVER_URL=ws://mcp-server:9000
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - XAI_API_KEY=${XAI_API_KEY}
      - LOG_LEVEL=INFO
    networks:
      - eunice-microservices
    depends_on:
      - mcp-server
    restart: unless-stopped

  # 4. Planning Agent (Port 8007)
  planning-agent:
    build: ./agents/planning
    container_name: eunice-planning-agent
    ports:
    environment:
      - SERVICE_HOST=0.0.0.0
      - SERVICE_PORT=8007
      - MCP_SERVER_URL=ws://mcp-server:9000
      - AGENT_TYPE=planning
      - LOG_LEVEL=INFO
    networks:
      - eunice-microservices
    depends_on:
      - mcp-server
    restart: unless-stopped
    healthcheck:
      interval: 30s
      timeout: 10s
      retries: 3

  # 8. Database Agent (Port 8011) - Moved to correct port per architecture
  database-agent:
    build: ./agents/database
    container_name: eunice-database-agent
    ports:
      - "8011:8011"
    environment:
      - SERVICE_HOST=0.0.0.0
      - SERVICE_PORT=8011
      - MCP_SERVER_URL=ws://mcp-server:9000
      - AGENT_TYPE=database
      - DATABASE_URL=postgresql://postgres:password@postgres:5432/eunice
      - LOG_LEVEL=INFO
    networks:
      - eunice-microservices
    depends_on:
      - mcp-server
      - postgres
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8011/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 9. Executor Agent (Port 8008)
  executor-agent:
    build: ./agents/executor
    container_name: eunice-executor-agent
    ports:
    environment:
      - SERVICE_HOST=0.0.0.0
      - SERVICE_PORT=8008
      - MCP_SERVER_URL=ws://mcp-server:9000
      - AGENT_TYPE=executor
      - LOG_LEVEL=INFO
    networks:
      - eunice-microservices
    depends_on:
      - mcp-server
    restart: unless-stopped
    healthcheck:
      interval: 30s
      timeout: 10s
      retries: 3

  # 10. Memory Agent Service (Port 8009)
  memory-agent:
    build: ./agents/memory
    container_name: eunice-memory-agent
    ports:
    environment:
      - SERVICE_HOST=0.0.0.0
      - SERVICE_PORT=8009
      - MCP_SERVER_URL=ws://mcp-server:9000
      - AGENT_TYPE=memory
      - LOG_LEVEL=INFO
    networks:
      - eunice-microservices
    depends_on:
      - mcp-server
    restart: unless-stopped
    healthcheck:
      interval: 30s
      timeout: 10s
      retries: 3

    # 5. Research Manager Agent (Port 8002)
  research-manager-agent:
    build: ./agents/research-manager
    container_name: eunice-research-manager
    ports:
    environment:
      - SERVICE_HOST=0.0.0.0
      - SERVICE_PORT=8002
      - MCP_SERVER_URL=ws://mcp-server:9000
      - AGENT_TYPE=research_manager
      - LOG_LEVEL=INFO
    networks:
      - eunice-microservices
    depends_on:
      - mcp-server
    restart: unless-stopped
    healthcheck:
      interval: 30s
      timeout: 10s
      retries: 3

  # 6. Literature Search Agent (Port 8003)
  literature-agent:
    build: ./agents/literature
    container_name: eunice-literature-agent
    ports:
    environment:
      - SERVICE_HOST=0.0.0.0
      - SERVICE_PORT=8003
      - MCP_SERVER_URL=ws://mcp-server:9000
      - AGENT_TYPE=literature
      - LOG_LEVEL=INFO
    networks:
      - eunice-microservices
    depends_on:
      - mcp-server
    restart: unless-stopped
    healthcheck:
      interval: 30s
      timeout: 10s
      retries: 3

  # 7. Screening PRISMA Agent (Port 8004) - SECURITY UPDATED
  screening-agent:
    build: ./agents/screening
    image: eunice/screening-agent:secure
    container_name: eunice-screening-agent
    ports:
    environment:
      - SERVICE_HOST=0.0.0.0
      - SERVICE_PORT=8004
      - MCP_SERVER_URL=ws://mcp-server:9000
      - AGENT_TYPE=screening
      - LOG_LEVEL=INFO
      # Security: Additional environment hardening
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
    networks:
      - eunice-microservices
    depends_on:
      - mcp-server
    restart: unless-stopped
    healthcheck:
      interval: 30s
      timeout: 10s
      retries: 3

  # 8. Synthesis & Review Agent (Port 8005) - NEW
  synthesis-agent:
    build: ./agents/synthesis
    image: eunice/synthesis-agent:secure
    container_name: eunice-synthesis-agent
    ports:
    environment:
      - SERVICE_HOST=0.0.0.0
      - SERVICE_PORT=8005
      - MCP_SERVER_URL=ws://mcp-server:9000
      - AGENT_TYPE=synthesis_review
      - LOG_LEVEL=INFO
      # Security: Additional environment hardening
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
    networks:
      - eunice-microservices
    depends_on:
      - mcp-server
    restart: unless-stopped
    healthcheck:
      interval: 30s
      timeout: 10s
      retries: 3

  # 9. Writer Agent (Port 8006) - NEW
  writer-agent:
    build: ./agents/writer
    image: eunice/writer-agent:secure
    container_name: eunice-writer-agent
    ports:
    environment:
      - SERVICE_HOST=0.0.0.0
      - SERVICE_PORT=8006
      - MCP_SERVER_URL=ws://mcp-server:9000
      - AGENT_TYPE=writer
      - LOG_LEVEL=INFO
      # Security: Additional environment hardening
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
    networks:
      - eunice-microservices
    depends_on:
      - mcp-server
    restart: unless-stopped
    healthcheck:
      interval: 30s
      timeout: 10s
      retries: 3

  # 11. Database (Pure Database Management - No API)
  database-service:
    build: ./services/database
    container_name: eunice-database
    environment:
      - DATABASE_URL=postgresql://postgres:password@postgres:5432/eunice
      - REDIS_URL=redis://redis:6379
      - LOG_LEVEL=INFO
      - HEALTH_CHECK_INTERVAL=30
      - MAINTENANCE_INTERVAL=3600
    networks:
      - eunice-microservices
    depends_on:
      - postgres
      - redis
    restart: unless-stopped

  # Supporting Infrastructure

  # Redis (Message Broker & Cache)
  redis:
    image: redis:7-alpine
    container_name: eunice-redis
    ports:
      - "6380:6379" # Use different external port to avoid conflict
    networks:
      - eunice-microservices
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: eunice-postgres
    ports:
      - "5433:5432" # Use different external port to avoid conflict
    environment:
      - POSTGRES_DB=eunice
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - eunice-microservices
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Development Tools (Optional)

  # Nginx (Load Balancer/Reverse Proxy + Frontend)
  nginx:
    image: nginx:alpine
    container_name: eunice-nginx
    ports:
      - "80:80"
    volumes:
      - ./infrastructure/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./frontend/dist:/usr/share/nginx/html:ro
    networks:
      - eunice-microservices
    depends_on:
      - api-gateway
    restart: unless-stopped
    profiles:
      - production
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/nginx-health"]
      interval: 30s
      timeout: 10s
      retries: 3

# Networks
networks:
  eunice-microservices:
    driver: bridge
    name: eunice-microservices
    labels:
      - "com.eunice.network=microservices"
      - "com.eunice.version=v0.3"

# Volumes
volumes:
  postgres-data:
    name: eunice-postgres-data
    labels:
      - "com.eunice.volume=database"
